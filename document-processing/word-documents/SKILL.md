---
name: docx
description: "トラック変更、コメント、書式保持、テキスト抽出をサポートした包括的なドキュメント作成、編集、分析。Claudeがプロフェッショナルドキュメント（.docxファイル）で以下の作業を行う場合に使用: (1) 新規ドキュメント作成、(2) コンテンツの変更・編集、(3) トラック変更の操作、(4) コメント追加、その他のドキュメント作業"
license: Proprietary. LICENSE.txt has complete terms
---

# DOCXの作成、編集、分析

## 概要

ユーザーは.docxファイルの作成、編集、分析を依頼することがあります。.docxファイルは本質的にXMLファイルとその他のリソースを含むZIPアーカイブであり、読み取りや編集が可能です。タスクに応じて異なるツールとワークフローが利用できます。

## ワークフロー決定ツリー

### コンテンツの読み取り/分析
以下の「テキスト抽出」または「生のXMLアクセス」セクションを使用

### 新規ドキュメント作成
「新しいWordドキュメントの作成」ワークフローを使用

### 既存ドキュメントの編集
- **自分のドキュメント + シンプルな変更**
  「基本的なOOXML編集」ワークフローを使用

- **他者のドキュメント**
  **「赤線ワークフロー」**を使用（推奨デフォルト）

- **法律、学術、ビジネス、政府文書**
  **「赤線ワークフロー」**を使用（必須）

## コンテンツの読み取りと分析

### テキスト抽出
ドキュメントのテキスト内容を読み取るだけの場合は、pandocを使用してドキュメントをMarkdownに変換します。Pandocはドキュメント構造の保持に優れたサポートを提供し、トラック変更を表示できます:

```bash
# トラック変更付きでドキュメントをMarkdownに変換
pandoc --track-changes=all path-to-file.docx -o output.md
# オプション: --track-changes=accept/reject/all
```

### 生のXMLアクセス
以下の機能にはXMLへの直接アクセスが必要です: コメント、複雑な書式設定、ドキュメント構造、埋め込みメディア、メタデータ。これらの機能を使用する場合は、ドキュメントを展開して生のXML内容を読み取る必要があります。

#### ファイルの展開
`python ooxml/scripts/unpack.py <office_file> <output_directory>`

#### 主要なファイル構造
- `word/document.xml` - メインのドキュメント内容
- `word/comments.xml` - document.xmlで参照されているコメント
- `word/media/` - 埋め込まれた画像とメディアファイル
- トラック変更は`<w:ins>`（挿入）と`<w:del>`（削除）タグを使用

## 新しいWordドキュメントの作成

ゼロから新しいWordドキュメントを作成する場合は、**docx-js**を使用します。これはJavaScript/TypeScriptを使用してWordドキュメントを作成できるライブラリです。

### ワークフロー
1. **必須 - ファイル全体を読む**: [`docx-js.md`](docx-js.md)（約500行）を最初から最後まで完全に読みます。**このファイルを読む際は範囲制限を設定しないでください。** ドキュメント作成を進める前に、詳細な構文、重要な書式設定ルール、ベストプラクティスについて完全なファイル内容を読み取ります。
2. Document、Paragraph、TextRunコンポーネントを使用してJavaScript/TypeScriptファイルを作成（すべての依存関係がインストールされていると仮定しますが、そうでない場合は以下の依存関係セクションを参照）
3. Packer.toBuffer()を使用して.docxとしてエクスポート

## 既存のWordドキュメントの編集

既存のWordドキュメントを編集する場合は、**Documentライブラリ**（OOXML操作用のPythonライブラリ）を使用します。このライブラリはインフラストラクチャのセットアップを自動的に処理し、ドキュメント操作のためのメソッドを提供します。複雑なシナリオでは、ライブラリを通じて基盤となるDOMに直接アクセスできます。

### ワークフロー
1. **必須 - ファイル全体を読む**: [`ooxml.md`](ooxml.md)（約600行）を最初から最後まで完全に読みます。**このファイルを読む際は範囲制限を設定しないでください。** ドキュメントファイルを直接編集するためのDocumentライブラリAPIとXMLパターンについて完全なファイル内容を読み取ります。
2. ドキュメントを展開: `python ooxml/scripts/unpack.py <office_file> <output_directory>`
3. Documentライブラリを使用してPythonスクリプトを作成・実行（ooxml.mdの「Document Library」セクションを参照）
4. 最終ドキュメントをパック: `python ooxml/scripts/pack.py <input_directory> <office_file>`

Documentライブラリは、一般的な操作のための高レベルメソッドと、複雑なシナリオのための直接DOM アクセスの両方を提供します。

## ドキュメントレビューのための赤線ワークフロー

このワークフローでは、OOXMLで実装する前にMarkdownを使用して包括的なトラック変更を計画できます。**重要**: 完全なトラック変更のためには、すべての変更を体系的に実装する必要があります。

**バッチング戦略**: 関連する変更を3〜10個の変更のバッチにグループ化します。これにより、効率性を維持しながらデバッグが管理しやすくなります。次のバッチに進む前に各バッチをテストします。

**原則: 最小限で正確な編集**
トラック変更を実装する際は、実際に変更されるテキストのみをマークします。変更されていないテキストを繰り返すと、編集のレビューが困難になり、非専門的に見えます。置換を次のように分割します: [変更なしテキスト] + [削除] + [挿入] + [変更なしテキスト]。変更なしテキストには、元の`<w:r>`要素から抽出して再利用することで、元のランのRSIDを保持します。

例 - 文中の「30日」を「60日」に変更:
```python
# 悪い例 - 文全体を置換
'<w:del><w:r><w:delText>The term is 30 days.</w:delText></w:r></w:del><w:ins><w:r><w:t>The term is 60 days.</w:t></w:r></w:ins>'

# 良い例 - 変更部分のみをマーク、変更なし部分には元の<w:r>を保持
'<w:r w:rsidR="00AB12CD"><w:t>The term is </w:t></w:r><w:del><w:r><w:delText>30</w:delText></w:r></w:del><w:ins><w:r><w:t>60</w:t></w:r></w:ins><w:r w:rsidR="00AB12CD"><w:t> days.</w:t></w:r>'
```

### トラック変更のワークフロー

1. **Markdown表現を取得**: トラック変更を保持してドキュメントをMarkdownに変換:
   ```bash
   pandoc --track-changes=all path-to-file.docx -o current.md
   ```

2. **変更を特定しグループ化**: ドキュメントをレビューし、必要なすべての変更を特定し、論理的なバッチに整理:

   **場所の特定方法**（XMLで変更を見つけるため）:
   - セクション/見出し番号（例: 「Section 3.2」、「Article IV」）
   - 段落番号（番号付きの場合）
   - 周囲の独自テキストを含むgrepパターン
   - ドキュメント構造（例: 「最初の段落」、「署名ブロック」）
   - **Markdownの行番号は使用しない** - XML構造にマッピングされない

   **バッチ編成**（バッチごとに3〜10個の関連する変更をグループ化）:
   - セクション別: 「バッチ1: セクション2の修正」、「バッチ2: セクション5の更新」
   - タイプ別: 「バッチ1: 日付修正」、「バッチ2: 当事者名の変更」
   - 複雑さ別: シンプルなテキスト置換から開始し、次に複雑な構造変更に取り組む
   - 順次: 「バッチ1: ページ1-3」、「バッチ2: ページ4-6」

3. **ドキュメントを読んで展開**:
   - **必須 - ファイル全体を読む**: [`ooxml.md`](ooxml.md)（約600行）を最初から最後まで完全に読みます。**このファイルを読む際は範囲制限を設定しないでください。** 特に「Document Library」と「Tracked Change Patterns」セクションに注意を払います。
   - **ドキュメントを展開**: `python ooxml/scripts/unpack.py <file.docx> <dir>`
   - **推奨RSIDをメモ**: 展開スクリプトはトラック変更に使用するRSIDを提案します。ステップ4bで使用するために、このRSIDをコピーします。

4. **バッチで変更を実装**: 変更を論理的にグループ化し（セクション別、タイプ別、または近接性別）、1つのスクリプトでまとめて実装します。このアプローチにより:
   - デバッグが容易になる（小さなバッチ = エラーの分離が容易）
   - 段階的な進捗が可能
   - 効率性を維持（3〜10個の変更のバッチサイズが最適）

   **推奨されるバッチグループ化:**
   - ドキュメントセクション別（例: 「セクション3の変更」、「定義」、「終了条項」）
   - 変更タイプ別（例: 「日付変更」、「当事者名更新」、「法律用語置換」）
   - 近接性別（例: 「ページ1-3の変更」、「ドキュメント前半の変更」）

   関連する変更の各バッチについて:

   **a. テキストをXMLにマッピング**: `word/document.xml`でテキストをgrepし、テキストが`<w:r>`要素間でどのように分割されているかを確認。

   **b. スクリプトを作成・実行**: `get_node`を使用してノードを見つけ、変更を実装し、`doc.save()`を実行。パターンについてはooxml.mdの**「Document Library」**セクションを参照。

   **注意**: スクリプトを書く直前に常に`word/document.xml`をgrepして、現在の行番号を取得し、テキスト内容を確認してください。行番号は各スクリプト実行後に変わります。

5. **ドキュメントをパック**: すべてのバッチが完了したら、展開されたディレクトリを.docxに戻します:
   ```bash
   python ooxml/scripts/pack.py unpacked reviewed-document.docx
   ```

6. **最終検証**: 完全なドキュメントの包括的なチェックを実行:
   - 最終ドキュメントをMarkdownに変換:
     ```bash
     pandoc --track-changes=all reviewed-document.docx -o verification.md
     ```
   - すべての変更が正しく適用されたことを確認:
     ```bash
     grep "original phrase" verification.md  # 見つからないはず
     grep "replacement phrase" verification.md  # 見つかるはず
     ```
   - 意図しない変更が導入されていないことを確認

## ドキュメントを画像に変換

Wordドキュメントを視覚的に分析するには、2段階のプロセスで画像に変換します:

1. **DOCXをPDFに変換**:
   ```bash
   soffice --headless --convert-to pdf document.docx
   ```

2. **PDFページをJPEG画像に変換**:
   ```bash
   pdftoppm -jpeg -r 150 document.pdf page
   ```
   これにより`page-1.jpg`、`page-2.jpg`などのファイルが作成されます。

オプション:
- `-r 150`: 解像度を150 DPIに設定（品質/サイズのバランスを調整）
- `-jpeg`: JPEG形式で出力（PNGが望ましい場合は`-png`を使用）
- `-f N`: 変換する最初のページ（例: `-f 2`はページ2から開始）
- `-l N`: 変換する最後のページ（例: `-l 5`はページ5で停止）
- `page`: 出力ファイルのプレフィックス

特定範囲の例:
```bash
pdftoppm -jpeg -r 150 -f 2 -l 5 document.pdf page  # ページ2-5のみを変換
```

## コードスタイルガイドライン
**重要**: DOCX操作のコードを生成する際:
- 簡潔なコードを書く
- 冗長な変数名や冗長な操作を避ける
- 不必要なprint文を避ける

## 依存関係

必要な依存関係（利用できない場合はインストール）:

- **pandoc**: `sudo apt-get install pandoc`（テキスト抽出用）
- **docx**: `npm install -g docx`（新規ドキュメント作成用）
- **LibreOffice**: `sudo apt-get install libreoffice`（PDF変換用）
- **Poppler**: `sudo apt-get install poppler-utils`（PDFを画像に変換するpdftoppm用）
- **defusedxml**: `pip install defusedxml`（安全なXML解析用）
